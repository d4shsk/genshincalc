<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genshin Calculator Interactive</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="data.js"></script>

    <style>
        /* --- Стили --- */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Roboto, sans-serif; }
        body {
            background-color: #0b0b15;
            background-image: radial-gradient(white, rgba(255,255,255,.2) 2px, transparent 3px),
            radial-gradient(white, rgba(255,255,255,.1) 2px, transparent 3px);
            background-size: 550px 550px, 350px 350px;
            color: #eee; height: 100vh; display: flex; overflow: hidden;
        }

        /* Sidebar */
        .sidebar { width: 60px; background: rgba(20, 20, 35, 0.9); display: flex; flex-direction: column; align-items: center; padding-top: 20px; border-right: 1px solid #333; z-index: 10; }
        .sidebar-icon { font-size: 20px; color: #555; margin-bottom: 25px; cursor: pointer; transition: color 0.2s; position: relative; width: 100%; text-align: center; padding: 10px 0;}
        .sidebar-icon:hover { color: #aaa; }
        .sidebar-icon.active { color: #dcbfa8; border-left: 3px solid #dcbfa8; background: rgba(255,255,255,0.05); }

        /* Main Content */
        .main-container { flex: 1; display: flex; flex-direction: column; padding: 20px; position: relative; }
        .panel-header-row { display: flex; justify-content: space-between; margin-bottom: 10px; padding: 0 10px; }
        .panel-title { font-size: 1.2rem; color: #dcbfa8; font-weight: bold; width: 48%; text-align: center; border-bottom: 1px solid #444; padding-bottom: 5px; }
        .content-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; height: 100%; overflow: hidden; }
        .panel { background: rgba(25, 25, 35, 0.85); border-radius: 10px; padding: 15px; overflow-y: auto; backdrop-filter: blur(5px); box-shadow: 0 4px 15px rgba(0,0,0,0.5); display: flex; flex-direction: column; }
        
        .tab-content { display: none; flex: 1; }
        .tab-content.active { display: block; }

        /* --- ТАБЛИЦА СТАТОВ --- */
        .stats-header { display: grid; grid-template-columns: 1fr 60px 80px 80px; font-size: 0.9rem; color: #aaa; margin-bottom: 10px; text-align: right; padding-right: 5px; }
        .stats-section-title { color: #dcbfa8; font-size: 0.9rem; margin: 15px 0 5px 0; }
        
        .stat-row { display: grid; grid-template-columns: 25px 1fr 60px 80px 80px; align-items: center; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.85rem; }
        .stat-icon { color: #aaa; text-align: center; }
        .stat-name { color: #ddd; }
        .stat-val { text-align: right; font-weight: bold; }
        .stat-total { color: #fff; }
        .boosted { color: #dcbfa8; } 

        .stat-input {
            width: 100%; background: rgba(0, 0, 0, 0.2); border: 1px solid #444; border-radius: 4px;
            color: #4caf50; font-weight: bold; text-align: right; font-size: 0.85rem; padding: 2px 5px; outline: none;
        }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

        /* --- ПРАВАЯ ПАНЕЛЬ --- */
        .item-header { display: flex; gap: 15px; margin-bottom: 20px; align-items: center; }
        
        .char-avatar { width: 80px; height: 80px; min-width: 80px; border-radius: 50%; background: #333; border: 2px solid #5e5e80; overflow: hidden; background-size: cover; cursor: pointer; transition: transform 0.2s; }
        .char-avatar:hover { transform: scale(1.05); }

        .weapon-avatar { width: 80px; height: 80px; min-width: 80px; border-radius: 8px; background: #333; border: 2px solid #555; overflow: hidden; background-size: cover; cursor: pointer; transition: transform 0.2s; }
        .weapon-avatar:hover { transform: scale(1.05); border-color: #fff; }
        
        .item-info h2 { font-size: 1.5rem; margin-bottom: 5px; color: #fff; }
        .stars { color: #ffce44; letter-spacing: 2px; font-size: 0.8rem; margin-bottom: 5px;}
        
        .weapon-stat-display { background: rgba(0,0,0,0.3); padding: 10px; border-radius: 6px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #444; }
        .weapon-stat-label { color: #aaa; font-size: 0.9rem; }
        .weapon-stat-val { font-size: 1.1rem; font-weight: bold; color: #fff; }

        /* Контролы баффов */
        .buff-control-box { background: rgba(0,0,0,0.3); border: 1px solid #444; border-radius: 6px; padding: 8px; margin-top: 8px; }
        .buff-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .buff-title { color: #dcbfa8; font-size: 0.8rem; font-weight: bold; }
        
        .toggle-switch { position: relative; display: inline-block; width: 34px; height: 18px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider-switch { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #444; transition: .4s; border-radius: 20px; }
        .slider-switch:before { position: absolute; content: ""; height: 14px; width: 14px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider-switch { background-color: #dcbfa8; }
        input:checked + .slider-switch:before { transform: translateX(16px); }

        /* --- СЛАЙДЕРЫ --- */
        .level-control { display: flex; align-items: center; margin-bottom: 15px; }
        .level-label { width: 140px; font-size: 0.9rem; display: flex; align-items: center; gap: 8px; }
        .custom-range { -webkit-appearance: none; flex: 1; height: 4px; background: #444; border-radius: 2px; outline: none; margin: 0 10px; cursor: pointer; }
        .custom-range::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; background: #fff; border-radius: 50%; cursor: pointer; box-shadow: 0 0 5px black; transition: background 0.2s; }
        .custom-range::-webkit-slider-thumb:hover { background: #dcbfa8; transform: scale(1.2); }
        .talent-val { width: 30px; text-align: center; font-weight: bold; color: #dcbfa8; }

        /* --- КАРТОЧКИ --- */
        .talent-card, .talent-constellation-card { background: rgba(30, 30, 40, 0.6); border: 1px solid #444; border-radius: 8px; padding: 10px; margin-bottom: 10px; font-size: 0.85rem; color: #ccc; }
        .talent-constellation-card { border-left: 5px solid #ffce44; }
        .talent-header { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; color: #fff; font-weight: bold; }
        .talent-attrs-table { margin-top: 8px; background: rgba(0,0,0,0.2); border-radius: 4px; padding: 5px; }
        .talent-attr-row { display: flex; justify-content: space-between; padding: 3px 0; border-bottom: 1px dashed rgba(255,255,255,0.1); font-size: 0.8rem; }
        .talent-attr-row:last-child { border-bottom: none; }
        .talent-attr-val { color: #dcbfa8; font-weight: bold; }

        /* Модальное окно */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; display: none; justify-content: center; align-items: center; }
        .modal-content { background: #1e1e2e; width: 400px; max-height: 80vh; border-radius: 12px; border: 1px solid #444; display: flex; flex-direction: column; }
        .modal-header { padding: 15px; background: #252535; border-bottom: 1px solid #333; font-weight: bold; color: #dcbfa8; }
        .list-container { padding: 10px; overflow-y: auto; }
        .select-item { display: flex; align-items: center; gap: 15px; padding: 10px; border-radius: 8px; cursor: pointer; transition: background 0.2s; margin-bottom: 5px; }
        .select-item:hover { background: #333; }
        .select-item img { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; background: #222; }
    </style>
</head>
<body>

    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-content">
            <div class="modal-header" id="modalTitle">Выберите</div>
            <div class="list-container" id="modalList"></div>
        </div>
    </div>

    <div class="sidebar">
        <div class="sidebar-icon active" onclick="switchTab('char')" id="tab-btn-char" title="Персонаж">
            <i class="fa-solid fa-user"></i>
        </div>
        <div class="sidebar-icon" onclick="switchTab('weapon')" id="tab-btn-weapon" title="Оружие">
            <i class="fa-solid fa-xmarks-lines"></i>
        </div>
    </div>

    <div class="main-container">
        <div class="panel-header-row">
            <div class="panel-title">Характеристики</div>
            <div class="panel-title" id="right-panel-title">Персонаж</div>
        </div>

        <div class="content-grid">
            
            <div class="panel">
                <div class="stats-header">
                    <div></div> <div>База</div> <div>Бонус</div> <div>Всего</div>
                </div>

                <div class="stats-section-title">Основные характеристики</div>
                
                <div class="stat-row">
                    <div class="stat-icon"><i class="fa-solid fa-droplet"></i></div>
                    <div class="stat-name">HP</div>
                    <div class="stat-val stat-base" id="base-hp">0</div>
                    <div style="padding: 0 5px;"><input type="number" class="stat-input" id="input-hp" placeholder="0" oninput="recalc()"></div>
                    <div class="stat-val stat-total" id="total-hp">0</div>
                </div>

                <div class="stat-row">
                    <div class="stat-icon"><i class="fa-solid fa-gavel"></i></div>
                    <div class="stat-name">Сила атаки</div>
                    <div class="stat-val stat-base" id="base-atk">0</div>
                    <div style="padding: 0 5px;"><input type="number" class="stat-input" id="input-atk" placeholder="0" oninput="recalc()"></div>
                    <div class="stat-val stat-total" id="total-atk">0</div>
                </div>
                
                <div class="stat-row">
                    <div class="stat-icon"><i class="fa-solid fa-shield-halved"></i></div>
                    <div class="stat-name">Защита</div>
                    <div class="stat-val stat-base" id="base-def">0</div>
                    <div style="padding: 0 5px;"><input type="number" class="stat-input" id="input-def" placeholder="0" oninput="recalc()"></div>
                    <div class="stat-val stat-total" id="total-def">0</div>
                </div>

                <div class="stat-row">
                    <div class="stat-icon"><i class="fa-solid fa-star-of-life"></i></div>
                    <div class="stat-name">Мастерство стихий</div>
                    <div class="stat-val stat-base" id="base-em">0</div>
                    <div style="padding: 0 5px;"><input type="number" class="stat-input" id="input-em" placeholder="0" oninput="recalc()"></div>
                    <div class="stat-val stat-total" id="total-em">0</div>
                </div>

                <div class="stats-section-title">Вторичные характеристики</div>

                <div class="stat-row">
                    <div class="stat-icon"><i class="fa-solid fa-bolt"></i></div>
                    <div class="stat-name">Восст. энергии</div>
                    <div class="stat-val stat-base" id="base-er">0%</div>
                    <div style="padding: 0 5px;"><input type="number" class="stat-input" id="input-er" placeholder="0" oninput="recalc()"></div>
                    <div class="stat-val stat-total" id="total-er">0%</div>
                </div>

                <div class="stat-row">
                    <div class="stat-icon"><i class="fa-solid fa-bullseye"></i></div>
                    <div class="stat-name">Шанс крит.</div>
                    <div class="stat-val stat-base" id="base-critRate">0%</div>
                    <div style="padding: 0 5px;"><input type="number" class="stat-input" id="input-critRate" placeholder="0" oninput="recalc()"></div>
                    <div class="stat-val stat-total" id="total-critRate">0%</div>
                </div>

                <div class="stat-row">
                    <div class="stat-icon"><i class="fa-solid fa-skull"></i></div>
                    <div class="stat-name">Крит. урон</div>
                    <div class="stat-val stat-base" id="base-critDmg">0%</div>
                    <div style="padding: 0 5px;"><input type="number" class="stat-input" id="input-critDmg" placeholder="0" oninput="recalc()"></div>
                    <div class="stat-val stat-total" id="total-critDmg">0%</div>
                </div>

                <div class="stat-row">
                    <div class="stat-icon"><i class="fa-solid fa-plus-square"></i></div>
                    <div class="stat-name">Бонус лечения</div>
                    <div class="stat-val stat-base" id="base-healingBonus">0%</div>
                    <div style="padding: 0 5px;"><input type="number" class="stat-input" id="input-healingBonus" placeholder="0" oninput="recalc()"></div>
                    <div class="stat-val stat-total" id="total-healingBonus">0%</div>
                </div>
                <div class="stat-row">
                    <div class="stat-icon"><i class="fa-solid fa-fire"></i></div>
                    <div class="stat-name">Бонус урона элемента</div>
                    <div class="stat-val stat-base" id="base-elementDamageBonus">0%</div>
                    <div style="padding: 0 5px;"><input type="number" class="stat-input" id="input-elementDamageBonus" placeholder="0" oninput="recalc()"></div>
                    <div class="stat-val stat-total" id="total-elementDamageBonus">0%</div>
                </div>
            </div>

            <div class="panel">
                
                <div id="tab-content-char" class="tab-content active">
                    <div class="item-header">
                        <div class="char-avatar" id="char-avatar-img" onclick="openModal('char')"></div>
                        <div class="item-info">
                            <h2 id="char-name">Имя</h2>
                            <div class="stars">★★★★★</div>
                            <div>Уровень <b id="char-level">90</b>/90</div>
                        </div>
                    </div>

                    <div class="level-control">
                        <div class="level-label"><i class="fa-solid fa-crosshairs"></i> Атака</div>
                        <input type="range" class="custom-range" id="slider-normal" min="1" max="10" value="10" oninput="updateTalentLevel(this, 'val-atk', 'normal')">
                        <div class="talent-val" id="val-atk">10</div>
                    </div>

                    <div class="level-control">
                        <div class="level-label"><i class="fa-solid fa-star"></i> Элем. навык</div>
                        <input type="range" class="custom-range" id="slider-skill" min="1" max="10" value="10" oninput="updateTalentLevel(this, 'val-skill', 'skill')">
                        <div class="talent-val" id="val-skill">10</div>
                    </div>

                    <div class="level-control">
                        <div class="level-label"><i class="fa-solid fa-burst"></i> Взрыв стихий</div>
                        <input type="range" class="custom-range" id="slider-burst" min="1" max="10" value="10" oninput="updateTalentLevel(this, 'val-burst', 'burst')">
                        <div class="talent-val" id="val-burst">10</div>
                    </div>

                    <hr style="border-color: #333; margin: 15px 0;">

                    <div class="level-control" style="margin-bottom: 30px;">
                        <div class="level-label" style="width: 140px; color: #ffce44;"><i class="fa-solid fa-gem"></i> Созвездия</div>
                        <input type="range" class="custom-range" id="slider-constellation" min="0" max="6" value="0" oninput="updateConstellations(this.value)">
                        <div class="talent-val" id="val-constellation">C0</div>
                    </div>

                    <div id="talents-container"></div>
                </div>

                <div id="tab-content-weapon" class="tab-content">
                    <div class="item-header">
                        <div class="weapon-avatar" id="weapon-avatar-img" onclick="openModal('weapon')"></div>
                        <div class="item-info">
                            <h2 id="weapon-name">Название оружия</h2>
                            <div class="stars">★★★★★</div>
                            <div>Уровень <b>90</b>/90</div>
                        </div>
                    </div>
                    
                    <p style="margin-bottom: 10px; color: #aaa;">Характеристики (Ур. 90)</p>

                    <div class="weapon-stat-display">
                        <span class="weapon-stat-label">Базовая атака</span>
                        <span class="weapon-stat-val" id="weapon-base-atk-val">0</span>
                    </div>

                    <div class="weapon-stat-display">
                        <span class="weapon-stat-label" id="weapon-substat-label">Характеристика</span>
                        <span class="weapon-stat-val" id="weapon-substat-val">0%</span>
                    </div>

                    <div class="talent-card" style="margin-top: 20px;">
                        <div class="talent-header"><i class="fa-solid fa-bolt"></i> Пассивная способность</div>
                        <p id="weapon-desc" style="opacity: 0.8; font-size: 0.85rem; margin-bottom: 15px;">Описание</p>
                        
                        <div id="weapon-passive-box"></div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // --- ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ---
        let currentChar = null;
        let currentWeapon = null;
        let totalBaseStats = {};
        let bonusStats = {};
        
        let activeBuffs = { weapon: 0 };
        let modal, modalList, modalTitle;

        // --- ЛОГИКА ---
        function switchTab(tab) {
            document.querySelectorAll('.sidebar-icon').forEach(icon => icon.classList.remove('active'));
            document.getElementById(`tab-btn-${tab}`).classList.add('active');
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`tab-content-${tab}`).classList.add('active');
            const titles = { 'char': 'Персонаж', 'weapon': 'Оружие' };
            document.getElementById('right-panel-title').innerText = titles[tab];
        }

        function openModal(type) {
            modalList.innerHTML = '';
            modal.style.display = 'flex';
            
            if (type === 'char') {
                modalTitle.innerText = "Выберите персонажа";
                charData.forEach(char => {
                    createModalItem(char, () => {
                        renderCharacter(char.id);
                        modal.style.display = 'none';
                    });
                });
            } else if (type === 'weapon') {
                modalTitle.innerText = "Выберите оружие";
                if (!currentChar) {
                    modalList.innerHTML = "<div style='padding:10px; color:#aaa'>Сначала выберите персонажа</div>";
                    return;
                }
                const filteredWeapons = weaponData.filter(w => w.type === currentChar.weaponType);
                if (filteredWeapons.length === 0) {
                    modalList.innerHTML = "<div style='padding:10px; color:#aaa'>Нет подходящего оружия</div>";
                }
                filteredWeapons.forEach(wep => {
                    createModalItem(wep, () => {
                        renderWeapon(wep.id);
                        modal.style.display = 'none';
                    });
                });
            }
        }

        function createModalItem(item, onClick) {
            const el = document.createElement('div');
            el.className = 'select-item';
            el.innerHTML = `
                <img src="${item.avatar || item.img}">
                <span style="font-weight:bold">${item.name}</span>
            `;
            el.onclick = onClick;
            modalList.appendChild(el);
        }

        function renderCharacter(charId) {
            currentChar = charData.find(c => c.id === charId);
            if (!currentChar) return;
            
            // Сброс активных баффов при смене персонажа
            activeBuffs = { weapon: activeBuffs.weapon || 0 }; 

            const elementColor = getElementColor(currentChar.element);

            // 1. Обновляем шапку
            document.getElementById('char-name').innerText = currentChar.name;
            const av = document.getElementById('char-avatar-img');
            av.style.backgroundImage = `url('${currentChar.avatar}')`;
            av.style.borderColor = elementColor;

            // 2. ВСЕГДА обновляем таланты (это исправление)
            renderTalents(currentChar, elementColor);

            // 3. Проверяем оружие
            if (currentWeapon && currentWeapon.type !== currentChar.weaponType) {
                // Если тип оружия не подходит, ищем дефолтное
                currentWeapon = null;
                const defaultWep = weaponData.find(w => w.type === currentChar.weaponType);
                
                if (defaultWep) {
                    renderWeapon(defaultWep.id); // Это также вызовет updateTotalStats
                } else {
                    // Если оружия нет, просто обновляем статы "голого" персонажа
                    updateTotalStats();
                }
            } else {
                // Если оружие подходит или его нет, просто пересчитываем статы
                updateTotalStats();
            }
        }

        function renderWeapon(weaponId) {
            currentWeapon = weaponData.find(w => w.id === weaponId);
            if (!currentWeapon) return;

            document.getElementById('weapon-name').innerText = currentWeapon.name;
            const av = document.getElementById('weapon-avatar-img');
            av.style.backgroundImage = `url('${currentWeapon.img}')`;
            av.style.borderColor = "#fff";

            document.getElementById('weapon-base-atk-val').innerText = currentWeapon.stats.baseAtk;
            const sub = currentWeapon.stats.subStat;
            document.getElementById('weapon-substat-label').innerText = sub.name;
            document.getElementById('weapon-substat-val').innerText = sub.value + (sub.isPercent ? '%' : '');
            
            const buff = currentWeapon.buff || {};
            document.getElementById('weapon-desc').innerHTML = `
                <strong style="color:#fff; display:block; margin-bottom:5px;">${buff.name || ''}</strong>
                ${buff.desc || ''}
            `;

            const weaponBox = document.getElementById('weapon-passive-box');
            weaponBox.innerHTML = '';
            activeBuffs.weapon = 0; 
            
            if(buff && buff.maxStacks) {
                const control = renderBuffControl(buff, 'weapon');
                weaponBox.appendChild(control);
            } else {
                weaponBox.innerHTML = '<span style="color:#777; font-size:0.8rem">Нет активного эффекта</span>';
            }

            updateTotalStats();
        }

        function renderBuffControl(buff, stateKey) {
            const container = document.createElement('div');
            container.className = 'buff-control-box';

            const header = document.createElement('div');
            header.className = 'buff-header';

            if (buff.maxStacks === 1) {
                header.innerHTML = `<span class="buff-title">Эффект активен</span>`;
                const label = document.createElement('label');
                label.className = 'toggle-switch';
                label.innerHTML = `<input type="checkbox" onchange="updateBuffState('${stateKey}', this.checked ? 1 : 0)"><span class="slider-switch"></span>`;
                header.appendChild(label);
                container.appendChild(header);
            } else {
                header.innerHTML = `
                    <span class="buff-title">Стаки эффекта</span>
                    <span style="font-size:0.8rem; color:#aaa" id="display-${stateKey}">0 / ${buff.maxStacks}</span>
                `;
                container.appendChild(header);

                const range = document.createElement('div');
                range.className = 'level-control';
                range.style.marginBottom = '0';
                range.innerHTML = `
                    <input type="range" class="custom-range" min="0" max="${buff.maxStacks}" value="0" oninput="updateBuffState('${stateKey}', this.value)">
                `;
                container.appendChild(range);
            }
            return container;
        }

        function updateBuffState(key, val) {
            activeBuffs[key] = parseInt(val);
            const display = document.getElementById(`display-${key}`);
            if (display) {
                let max = 1;
                if (key === 'weapon' && currentWeapon && currentWeapon.buff) max = currentWeapon.buff.maxStacks;
                else if (currentChar) {
                    const parts = key.split('-');
                    const idx = parseInt(parts[1]);
                    if (currentChar.talents[idx].buff) max = currentChar.talents[idx].buff.maxStacks;
                }
                display.innerText = `${activeBuffs[key]} / ${max}`;
            }
            updateTotalStats();
        }

        function updateMaxTalentLevels() {
            if (!currentChar) return;
            const currentC = parseInt(document.getElementById('slider-constellation').value);
            
            const maxLevels = { normal: 10, skill: 10, burst: 10 };

            currentChar.talents.forEach(talent => {
                if (talent.type === 'constellation' && talent.level <= currentC && talent.levelBoost) {
                    const targetType = talent.levelBoost.type;
                    maxLevels[targetType] += talent.levelBoost.value; 
                }
            });

            ['normal', 'skill', 'burst'].forEach(type => {
                const slider = document.getElementById(`slider-${type}`);
                if (slider) {
                    const newMax = maxLevels[type];
                    slider.max = newMax;
                    
                    // ЕСЛИ ТЕКУЩЕЕ ЗНАЧЕНИЕ БОЛЬШЕ НОВОГО МАКСИМУМА
                    if (parseInt(slider.value) > newMax) {
                        slider.value = newMax; // Сбрасываем значение
                        // ПРИНУДИТЕЛЬНО ОБНОВЛЯЕМ ЦИФРЫ В ИНТЕРФЕЙСЕ
                        const outputId = `val-${type === 'normal' ? 'atk' : type}`;
                        updateTalentLevel(slider, outputId, type);
                    }
                }
            });
        }

        function updateTotalStats() {
            if (!currentChar) return;

            totalBaseStats = {};
            bonusStats = {}; 

            for (const key in currentChar.stats) {
                totalBaseStats[key] = currentChar.stats[key].base;
            }

            if (currentWeapon) {
                totalBaseStats['atk'] += currentWeapon.stats.baseAtk;
                const sub = currentWeapon.stats.subStat;
                if(sub) addBonus(sub.key, sub.value);
                
                const wBuff = currentWeapon.buff;
                const wStacks = activeBuffs['weapon'] || 0;
                if (wBuff && wStacks > 0) {
                    applyBuff(wBuff.bonusPerStack, wStacks);
                }
            }

            currentChar.talents.forEach((talent, idx) => {
                const tBuff = talent.buff;
                if (tBuff) {
                    if (talent.type === 'constellation') {
                        const currentConstellation = parseInt(document.getElementById('slider-constellation').value);
                        if (talent.level > currentConstellation) return; 
                    }

                    const tStacks = activeBuffs[`talent-${idx}`] || 0;
                    if (tStacks > 0) {
                        applyBuff(tBuff.bonusPerStack, tStacks);
                    }
                }
            });

            for (const key in totalBaseStats) {
                const isPercent = currentChar.stats[key].isPercent;
                const el = document.getElementById(`base-${key}`);
                if (el) {
                    el.innerText = formatStat(totalBaseStats[key], isPercent);
                    if (key === 'atk' && currentWeapon) el.classList.add('boosted');
                    else el.classList.remove('boosted');
                }
            }
            recalc();
        }

        function addBonus(key, value) {
            bonusStats[key] = (bonusStats[key] || 0) + value;
        }

        function applyBuff(bonusObj, stacks) {
            for (const key in bonusObj) {
                addBonus(key, bonusObj[key] * stacks);
            }
        }

        function recalc() {
            if (!currentChar) return;
            const allStats = ['hp', 'atk', 'def', 'em', 'er', 'critRate', 'critDmg', 'healingBonus', 'elementDamageBonus'];

            allStats.forEach(key => {
                const isPercent = currentChar.stats[key].isPercent;
                const base = totalBaseStats[key] || 0;
                const inputVal = parseFloat(document.getElementById(`input-${key}`).value) || 0;
                const bonus = bonusStats[key] || 0;
                const total = base + inputVal + bonus;

                const totalEl = document.getElementById(`total-${key}`);
                totalEl.innerText = formatStat(total, isPercent);
                
                if (bonus > 0) totalEl.style.color = "#dcbfa8";
                else totalEl.style.color = "#fff";
            });
        }

        function getElementColor(el) {
            if(el == "hydro") return "#84a5ff";
            if(el == "electro") return "#d1aef8";
            if(el == "dendro") return "#B2EB29";
            return "#fff";
        }

        function formatStat(val, isPercent) {
            if (isPercent) return val.toFixed(1) + '%';
            return Math.round(val).toLocaleString('ru-RU');
        }

        function renderTalents(char, color) {
            const container = document.getElementById('talents-container');
            container.innerHTML = '';
            
            char.talents.forEach((talent, idx) => {
                const isConstellation = talent.type === 'constellation';
                let contentHTML = '';

                if (talent.buff) {
                    const control = renderBuffControl(talent.buff, `talent-${idx}`);
                    contentHTML += control.outerHTML;
                }

                if (isConstellation) {
                    const div = document.createElement('div');
                    div.className = 'talent-constellation-card';
                    div.setAttribute('data-c-level', talent.level);
                    div.style.display = 'none'; 
                    div.innerHTML = `
                        <div class="talent-header"><span style="background:#333;padding:2px 6px;border-radius:4px;margin-right:5px;border:1px solid #555;">C${talent.level}</span> ${talent.title}</div>
                        <p style="opacity:0.8">${talent.desc}</p>
                        ${contentHTML}
                    `;
                    container.appendChild(div);
                } else {
                    const isActive = ['normal', 'skill', 'burst'].includes(talent.type);
                    let attrHtml = '';
                    if (isActive && talent.attributes) {
                        attrHtml += '<div class="talent-attrs-table">';
                        talent.attributes.forEach((attr, attrIdx) => {
                            attrHtml += `<div class="talent-attr-row"><span>${attr.name}</span><span class="talent-attr-val" id="val-${talent.type}-${attrIdx}">...</span></div>`;
                        });
                        attrHtml += '</div>';
                    }

                    const div = document.createElement('div');
                    div.className = 'talent-card';
                    div.innerHTML = `
                        <div class="talent-header" style="color:${color}">${talent.title}</div>
                        <p style="opacity:0.8">${talent.desc}</p>
                        ${attrHtml}
                        ${contentHTML}
                    `;
                    container.appendChild(div);
                }
            });

            ['normal', 'skill', 'burst'].forEach(t => {
                const slider = document.getElementById(`slider-${t}`);
                if(slider) {
                    slider.value = 10;
                    updateTalentLevel(slider, `val-${t === 'normal' ? 'atk' : t}`, t);
                }
            });

            const cSlider = document.getElementById('slider-constellation');
            cSlider.value = 0;
            updateConstellations(0); 
        }

        function updateTalentLevel(slider, outputId, type) {
            const level = parseInt(slider.value);
            document.getElementById(outputId).innerText = level;
            if (!currentChar) return;
            const talent = currentChar.talents.find(t => t.type === type);
            if (!talent || !talent.attributes) return;

            talent.attributes.forEach((attr, idx) => {
                const el = document.getElementById(`val-${type}-${idx}`);
                if (el) {
                    let val = 0;
                    if (level <= attr.values.length) {
                        val = attr.values[level - 1];
                    } else {
                        const last = attr.values[attr.values.length - 1];
                        const prev = attr.values[attr.values.length - 2];
                        const step = last - prev;
                        const extraLevels = level - attr.values.length;
                        val = last + (step * extraLevels);
                        val = parseFloat(val.toFixed(1));
                    }
                    el.innerText = val + (attr.name.includes('КД') ? '' : '%');
                }
            });
        }

        function updateConstellations(val) {
            const level = parseInt(val);
            document.getElementById('val-constellation').innerText = "C" + level;
            const cards = document.querySelectorAll('.talent-constellation-card');
            
            cards.forEach(card => {
                const cLvl = parseInt(card.getAttribute('data-c-level'));
                if (cLvl <= level) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
            
            updateMaxTalentLevels(); 
            updateTotalStats();
        }

        // --- ЗАПУСК ПОСЛЕ ЗАГРУЗКИ DOM ---
        document.addEventListener('DOMContentLoaded', () => {
            modal = document.getElementById('modalOverlay');
            modalList = document.getElementById('modalList');
            modalTitle = document.getElementById('modalTitle');

            modal.onclick = (e) => { if (e.target === modal) modal.style.display = 'none'; };

            renderCharacter(charData[0].id);
            const firstWep = weaponData.find(w => w.type === charData[0].weaponType);
            if(firstWep) renderWeapon(firstWep.id);
        });

    </script>
</body>
</html>